{{! views/checkout.hbs - RENDER with { layout: 'main', title: 'Checkout', cssFile: 'checkout.css' } }}

<main class="checkout-page container">
    <div class="checkout-grid">
        <section class="shipping-payment-section">
            <h1 class="page-title">Checkout</h1>
            
            <div class="checkout-step" id="shipping-step">
                <div class="step-header">
                    <h2>1. Shipping Address</h2>
                    <button class="edit-btn" data-step="shipping">Change</button>
                </div>
                <div class="step-content">
                    <div id="currentAddress">
                        <p>John Doe</p>
                        <p>123 Main Street, Apt 4B</p>
                        <p>New York, 10001, USA</p>
                        <p class="default-label">Default Shipping Address</p>
                    </div>
                </div>
                <div id="addressFormContainer" class="form-container" style="display: none;">
                    <form id="shippingAddressForm">
                        <div class="form-group">
                            <label for="checkoutFullName">Full Name</label>
                            <input type="text" id="checkoutFullName" value="John Doe">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="cta-btn">Save & Continue</button>
                            <button type="button" class="cta-btn secondary-btn cancel-edit">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="checkout-step" id="payment-step">
                <div class="step-header">
                    <h2>2. Payment Details</h2>
                    <button class="edit-btn" data-step="payment">Change</button>
                </div>
                <div class="step-content">
                    <div id="currentPayment">
                        <p>Visa ending in 4242</p>
                        <p>Expires 12/26</p>
                    </div>
                </div>
                <div id="paymentFormContainer" class="form-container" style="display: none;">
                    <form id="paymentForm">
                        <div class="form-group">
                            <label for="cardNumber">Card Number</label>
                            <input type="text" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="cardExpiry">Expiry (MM/YY)</label>
                                <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group half-width">
                                <label for="cardCVC">CVC</label>
                                <input type="text" id="cardCVC" placeholder="XXX" maxlength="4">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cardName">Name on Card</label>
                            <input type="text" id="cardName" placeholder="John Doe">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="cta-btn">Save & Continue</button>
                            <button type="button" class="cta-btn secondary-btn cancel-edit">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="addressMessage" class="message-area"></div>
            
            <button id="placeOrderBtn" class="cta-btn primary-cta">Place Order (â‚¹ <span id="finalTotal">2,11,440</span>)</button>

        </section>

        <aside class="order-summary-sidebar">
            <h2>Order Summary</h2>
            <div class="order-items-list" id="orderItemsList">
                <div class="order-item">
                    <img src="ring-solitaire.jpg" alt="Solitaire Ring">
                    <div class="item-details">
                        <p>Classic Solitaire Ring</p>
                        <p class="meta">Qty: 1 | 18k Gold</p>
                    </div>
                    <span class="item-price">â‚¹ 75,000</span>
                </div>
                <div class="order-item">
                    <img src="bracelet-sapphire.jpg" alt="Sapphire Bangle">
                    <div class="item-details">
                        <p>Celestial Sapphire Bangle</p>
                        <p class="meta">Qty: 2 | 18k Rose Gold</p>
                    </div>
                    <span class="item-price">â‚¹ 1,24,000</span>
                </div>
            </div>

            <div class="promo-code-box">
                <input type="text" class="promo-input" placeholder="Promo Code">
                <button class="apply-btn">Apply</button>
            </div>
            
            <div class="summary-breakdown">
                <div class="summary-line">
                    <span>Subtotal</span>
                    <span id="subtotal">â‚¹ 1,99,000</span>
                </div>
                <div class="summary-line">
                    <span>Shipping</span>
                    <span id="shippingFee">FREE</span>
                </div>
                <div class="summary-line">
                    <span>Discount (<span id="discountLabel">None</span>)</span>
                    <span id="discountAmount">- â‚¹ 0</span>
                </div>
                <div class="summary-line total-line">
                    <h3>Order Total</h3>
                    <span id="orderTotal">â‚¹ 1,99,000</span>
                </div>
            </div>
        </aside>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-content small-modal">
            <h2 class="success-title"><i class="fas fa-check-circle"></i> Order Placed!</h2>
            <p>Your order (AURELIA-98765) has been confirmed. A confirmation email is on its way!</p>
            <button class="cta-btn" onclick="window.location.href='/myorder'">View Order</button>
        </div>
    </div>
</main>

<script>
    let currentSubtotal = 199000;
    let shippingFee = 0;
    let discount = 0;
    let appliedCoupon = null;

    // Utility function for address messages (uses the dedicated div, not the global toast)
    function showAddressMessage(message, type = 'info') {
        const messageEl = document.getElementById('addressMessage');
        if (!messageEl) return;
        messageEl.textContent = message;
        messageEl.className = `message-area message-${type}`;
        setTimeout(() => messageEl.textContent = '', 4000);
    }

    function formatCurrency(amount) {
        return 'â‚¹ ' + amount.toLocaleString('en-IN');
    }

    function applyDiwaliCoupon() {
        // Simple logic for Buy 1 Get 1 Free (BOGO). 
        // For demonstration: assumes the discount is a fixed amount based on the example items.
        // Real BOGO logic would require checking item quantities and prices.
        
        // Example: Assume BOGO applies to the cheaper item (Ring @ 75k)
        // If two items are 75k and 62k, the free item would be 62k.
        // For simplicity, let's hardcode a significant discount.
        discount = 50000; 
    }

    function updateOrderSummary() {
        const orderTotal = currentSubtotal - discount + shippingFee;

        document.getElementById('subtotal').textContent = formatCurrency(currentSubtotal);
        document.getElementById('shippingFee').textContent = shippingFee === 0 ? 'FREE' : formatCurrency(shippingFee);
        document.getElementById('discountLabel').textContent = appliedCoupon || 'None';
        document.getElementById('discountAmount').textContent = `- ${formatCurrency(discount)}`;
        document.getElementById('orderTotal').textContent = formatCurrency(orderTotal);
        document.getElementById('finalTotal').textContent = formatCurrency(orderTotal);
    }

    // --- Address/Payment Editing Logic ---
    function initializeAddressEditing() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const step = this.dataset.step;
                const formContainer = document.getElementById(step + 'FormContainer');
                const content = document.querySelector(`#${step}-step .step-content`);
                
                content.style.display = 'none';
                this.style.display = 'none';
                formContainer.style.display = 'block';

                document.querySelectorAll('.cancel-edit').forEach(cancelBtn => {
                    cancelBtn.onclick = () => {
                        formContainer.style.display = 'none';
                        content.style.display = 'block';
                        btn.style.display = 'block';
                    };
                });
            });
        });

        document.getElementById('shippingAddressForm').onsubmit = (e) => {
            e.preventDefault();
            // Simulate save
            const saveBtn = document.querySelector('#shippingAddressForm button[type="submit"]');
            saveBtn.textContent = 'Saving...';
            setTimeout(() => {
                showAddressMessage('âœ… Shipping Address updated!', 'success');
                // Hide form, show content
                document.querySelector('.cancel-edit').click();
                saveBtn.textContent = 'Save & Continue';
            }, 1000);
        };
    }

    // --- Card Formatting ---
    function initializeCardFormatting() {
        const cardNumber = document.getElementById('cardNumber');
        const cardExpiry = document.getElementById('cardExpiry');

        if (cardNumber) {
            cardNumber.addEventListener('input', function(e) {
                const value = e.target.value.replace(/\s/g, '');
                e.target.value = value.match(/.{1,4}/g)?.join(' ') || '';
            });
        }
        
        if (cardExpiry) {
            cardExpiry.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }

        document.getElementById('paymentForm').onsubmit = (e) => {
            e.preventDefault();
            // Simulate save
            const saveBtn = document.querySelector('#paymentForm button[type="submit"]');
            saveBtn.textContent = 'Saving...';
            setTimeout(() => {
                showAddressMessage('âœ… Payment Details updated!', 'success');
                // Hide form, show content
                document.querySelector('#paymentFormContainer .cancel-edit').click();
                saveBtn.textContent = 'Save & Continue';
            }, 1000);
        };
    }
    
    // --- Promo Code Logic ---
    function initializePromoCode() {
        const applyBtn = document.querySelector('.apply-btn');
        const promoInput = document.querySelector('.promo-input');
        
        if (!applyBtn || !promoInput) return;
        
        // Use a new button clone to remove and re-add the listener cleanly
        const newApplyBtn = applyBtn.cloneNode(true);
        applyBtn.parentNode.replaceChild(newApplyBtn, applyBtn);
        
        newApplyBtn.addEventListener('click', function() {
            const code = promoInput.value.trim().toUpperCase();
            
            if (!code) {
                showAddressMessage('âš ï¸ Please enter a promo code', 'error');
                return;
            }
            
            if (code === 'DIWALI') {
                appliedCoupon = code;
                applyDiwaliCoupon();
                updateOrderSummary();
                showAddressMessage('ðŸŽ‰ DIWALI Coupon Applied! Buy 1 Get 1 Free!', 'success');
            } else {
                showAddressMessage('âš ï¸ Invalid promo code. Please try again.', 'error');
            }
        });
    }

    // --- Place Order Logic ---
    document.getElementById('placeOrderBtn').onclick = () => {
        document.getElementById('placeOrderBtn').textContent = 'Processing...';
        
        setTimeout(() => {
            document.getElementById('placeOrderBtn').textContent = 'Order Placed!';
            document.getElementById('successModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Redirect after 5 seconds
            setTimeout(() => {
                window.location.href = '/myorder'; 
            }, 5000);
        }, 1500);
    };

    document.addEventListener('DOMContentLoaded', function() {
        initializeAddressEditing();
        initializeCardFormatting();
        initializePromoCode();
        updateOrderSummary();
    });
</script>