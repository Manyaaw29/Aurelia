{{! views/cart.hbs - RENDER with { layout: 'main', title: 'Shopping Cart', cssFile: 'cart.css' } }}

<main class="cart-page container">
    <h1>Your Shopping Cart</h1>

    <div class="cart-grid">
        <section class="cart-items">
            <div class="cart-item">
                <a href="/product/classic-solitaire" class="item-image-link">
                    <img src="ring-solitaire.jpg" alt="Classic Solitaire Ring" class="item-image">
                </a>
                <div class="item-details">
                    <a href="/product/classic-solitaire" class="item-name">Classic Solitaire Ring</a>
                    <p class="item-sku">SKU: SOL101</p>
                    <p class="item-meta">18k Gold | 1.0ct Lab Diamond</p>
                    <div class="item-actions">
                        <button class="remove-btn" data-id="1"><i class="fas fa-trash-alt"></i> Remove</button>
                        <button class="wishlist-btn" data-id="1"><i class="far fa-heart"></i> Move to Wishlist</button>
                    </div>
                </div>
                <div class="item-price-controls">
                    <div class="quantity-control">
                        <button class="qty-btn minus-btn" data-id="1">-</button>
                        <input type="number" class="qty-input" value="1" min="1" data-id="1" id="qty-input-1">
                        <button class="qty-btn plus-btn" data-id="1">+</button>
                    </div>
                    <p class="item-total-price" data-price="75000">₹ 75,000</p>
                </div>
            </div>

            <div class="cart-item">
                <a href="/product/celestial-bangle" class="item-image-link">
                    <img src="bracelet-sapphire.jpg" alt="Celestial Sapphire Bangle" class="item-image">
                </a>
                <div class="item-details">
                    <a href="/product/celestial-bangle" class="item-name">Celestial Sapphire Bangle</a>
                    <p class="item-sku">SKU: BAN205</p>
                    <p class="item-meta">18k Rose Gold | Blue Sapphire</p>
                    <div class="item-actions">
                        <button class="remove-btn" data-id="2"><i class="fas fa-trash-alt"></i> Remove</button>
                        <button class="wishlist-btn" data-id="2"><i class="far fa-heart"></i> Move to Wishlist</button>
                    </div>
                </div>
                <div class="item-price-controls">
                    <div class="quantity-control">
                        <button class="qty-btn minus-btn" data-id="2">-</button>
                        <input type="number" class="qty-input" value="2" min="1" data-id="2" id="qty-input-2">
                        <button class="qty-btn plus-btn" data-id="2">+</button>
                    </div>
                    <p class="item-total-price" data-price="62000">₹ 1,24,000</p>
                </div>
            </div>

            <div class="cart-actions">
                <a href="/product" class="continue-shopping"><i class="fas fa-arrow-left"></i> Continue Shopping</a>
            </div>
        </section>

        <aside class="cart-summary">
            <h2>Order Summary</h2>
            <div class="summary-line">
                <span>Items (<span id="items-count-sidebar">3</span>)</span>
                <span id="subtotal-amount">₹ 1,99,000</span>
            </div>
            <div class="summary-line">
                <span>Shipping Estimate</span>
                <span>FREE</span>
            </div>
            <div class="summary-line total-line">
                <span>Estimated Total</span>
                <span id="estimated-total-amount">₹ 1,99,000</span>
            </div>
            
            <button class="checkout-btn cta-btn">Proceed to Checkout</button>
            <p class="secure-checkout-text"><i class="fas fa-lock"></i> Secure Checkout Guaranteed</p>

            <div class="newsletter-signup">
                <h3>Get 10% Off!</h3>
                <p>Subscribe to our newsletter for exclusive discounts.</p>
                <form id="cartNewsletterForm">
                    <input type="email" placeholder="Enter your email" required id="cartNewsletterEmail">
                    <button type="submit">Subscribe</button>
                </form>
                <p id="newsletterMessage" class="success-message-inline" style="display: none;"></p>
            </div>
        </aside>
    </div>
</main>

<div id="checkoutModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">&times;</button>
        <h2 id="modalTitle"></h2>
        <p id="modalText"></p>
        <button class="cta-btn secondary-btn" onclick="closeModal()">Close</button>
    </div>
</div>

<script>
    // --- UTILITY FUNCTIONS ---
    function formatCurrency(amount) {
        return '₹ ' + amount.toLocaleString('en-IN');
    }

    // --- MODAL FUNCTIONS (Page Specific) ---
    const modal = document.getElementById('checkoutModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');

    function showModal(title, text) {
        modalTitle.textContent = title;
        modalText.textContent = text;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // Close modal if clicked outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // --- CORE CART LOGIC ---
    let cartItems = [
        { id: 1, name: "Classic Solitaire Ring", price: 75000, quantity: 1 },
        { id: 2, name: "Celestial Sapphire Bangle", price: 62000, quantity: 2 }
    ];

    function updateCartItem(id, newQuantity) {
        const item = cartItems.find(i => i.id === id);
        if (!item) return;

        if (newQuantity < 1) {
            // Remove item if quantity is 0
            removeItem(id);
            return;
        }

        item.quantity = newQuantity;

        // Update the item's DOM total price
        const itemElement = document.querySelector(`.cart-item .item-total-price[data-price='${item.price * item.quantity / item.quantity}']`);
        if (itemElement) {
            itemElement.textContent = formatCurrency(item.price * item.quantity);
        }
        
        // Update the quantity input
        document.getElementById(`qty-input-${id}`).value = newQuantity;

        updateSummary();
    }

    function removeItem(id) {
        cartItems = cartItems.filter(i => i.id !== id);
        // Remove the item's DOM element
        const itemElement = document.querySelector(`.remove-btn[data-id='${id}']`).closest('.cart-item');
        if (itemElement) {
            itemElement.remove();
        }
        updateSummary();
        // Uses global showNotification from footer.hbs
        showNotification('Item removed from cart.'); 
    }

    function updateSummary() {
        let subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let itemCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

        document.getElementById('items-count-sidebar').textContent = itemCount;
        document.getElementById('subtotal-amount').textContent = formatCurrency(subtotal);
        document.getElementById('estimated-total-amount').textContent = formatCurrency(subtotal);

        // Optional: Update global cart count icon (assuming an element exists in header.hbs)
        const cartCountHeader = document.querySelector('.cart-count');
        if (cartCountHeader) {
            cartCountHeader.textContent = itemCount;
        }
    }

    // --- EVENT LISTENERS ---

    // Quantity controls
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            const input = document.getElementById(`qty-input-${id}`);
            let quantity = parseInt(input.value);

            if (e.target.classList.contains('plus-btn')) {
                quantity++;
            } else if (e.target.classList.contains('minus-btn')) {
                quantity--;
            }
            
            updateCartItem(id, quantity);
        });
    });

    // Remove item buttons
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            removeItem(id);
        });
    });

    // Move to Wishlist (Example)
    document.querySelectorAll('.wishlist-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            const item = cartItems.find(i => i.id === id);
            if (item) {
                // Uses global showNotification from footer.hbs
                showNotification(`${item.name} moved to Wishlist!`); 
                removeItem(id);
            }
        });
    });


    // --- NEWSLETTER SUBSCRIPTION LOGIC (Page Specific) ---
    document.getElementById('cartNewsletterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('cartNewsletterEmail');
        const messageElement = document.getElementById('newsletterMessage');
        
        if (emailInput.value) {
            messageElement.textContent = '✅ You have subscribed and received 10% off!';
            messageElement.style.display = 'block';

            emailInput.value = '';

            setTimeout(() => {
                messageElement.style.display = 'none';
                messageElement.textContent = '';
            }, 5000); 
        }
    });

    // --- UPDATED CHECKOUT LOGIC ---
    document.querySelector('.checkout-btn').addEventListener('click', function(e) {
        e.preventDefault(); 
        
        // Re-check item count
        const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
        
        if (totalItems === 0) {
            showModal('Cart Empty', 'Please add items to your cart before proceeding to checkout.');
            return; 
        }

        showModal('Proceeding to Checkout', 'You will be redirected in 3 seconds...');

        setTimeout(() => {
            closeModal();
            window.location.href = '/checkout'; // Redirect to the checkout page
        }, 3000); 
    });

    // Initial update on load
    document.addEventListener('DOMContentLoaded', updateSummary);
</script>